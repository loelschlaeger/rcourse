---
title: "Data Manipulation"
author: "Lennart Oelschl&auml;ger"
date: "Version of `r format(Sys.Date(), '%d.%m.%Y')`"
output: 
  slidy_presentation:
    smart: true
    highlight: rstudio
---

```{r, include = FALSE}
Sys.setenv(LANG = "en")
```
  
## Why and what 

Welcome to this tiny course on data manipulation in R with [{dplyr}](https://dplyr.tidyverse.org/)! `r emo::ji("wave")`

### Why do we care?

Data rarely comes to you in the form you need it. Often you want to filter for a subset, create new variables, rename columns, or reorder observations. 

### Why {dplyr}?

The {dplyr} package provides the most elegant and versatile tools for data manipulation in R. It is part of the [tidyverse](https://www.tidyverse.org/), a collection of R packages that share a common philosophy of data and programming and thereby work well together. The [{ggplot2} package](https://ggplot2.tidyverse.org/) is another popular member.

### What is this course about?

Being in "decent control" of {dplyr} for efficient data wrangling.

### What do you need?

Basic R skills + a not-too-old version of R (>= 2.10) + RStudio

### At the end of the day...

```r
prices %>% 
  group_by(symbol) %>% 
  summarize(count = n()) %>%
  select(count) %>%
  table()
```

### Course material

Executing the following lines in R gives you access to the course material:

```{r, eval = FALSE}
install.packages("remotes")
remotes::install_github("loelschlaeger/rcourse", upgrade = "never")
library("rcourse")
```

To open a copy of these slides, type:

```{r, eval = FALSE}
slides()
```

To start the practicals, type:

```{r, eval = FALSE}
practicals()
```

### Sources

- Wickham and Grolemund (2020): [R for Data Science](https://r4ds.had.co.nz/)

### Found mistakes? Have suggestions?

You can leave a note [here on GitHub](https://github.com/loelschlaeger/rcourse/issues/new/choose). `r emo::ji("wish")`

## Filter and arrange data rows

Load {dplyr}.

```{r}
# install.packages(dplyr)
library(dplyr)
```

Just started and already warnings... What do they tell us?

We'll work with a data set of stocks in the American S&P 500 index from 2012 to 2016: `r emo::ji("money_with_wings")`

```{r}
(stocks <- rcourse::stocks)
```

We learn the first {dplyr} verb: `filter()`. It allows to subset observations based on their values. For example:

```{r}
filter(stocks, sector == "Energy")
```

R provides the following expressions for comparisons:

- `>`
- `>=`
- `<`
- `<=`
- `==` (equal)
- `!=` (not equal)

You can add multiple arguments to `filter()`, for example:

```{r}
filter(stocks, sector != "Industrials", added < as.Date("1970-01-01"))
```

Every expression must be true in order for a row to be included in the output. All logical operators:

- `&` (and)
- `|` (or)
- `xor()` (exclusive or)
- `!` (not)

`filter()` excludes missing values (`NA`). To preserve them:

```{r}
filter(stocks, added > as.Date("2016-01-01") | is.na(added))
```

We learn a second {dplyr} verb: `arrange()`. It works similar to `filter()` and changes the order of the data rows. For example:

```{r}
arrange(stocks, symbol)
```

Use `desc()` to reorder by a column in descending order:

```{r}
arrange(stocks, desc(symbol))
```

You can provide more than one variable name to sort with respect to multiple columns:

```{r}
arrange(stocks, sector, industry)
```

## Select and create data columns

The `stocks` data set only has `r ncol(stocks)` columns, but it is not uncommon to have data sets with much more variables. In that case, you might want to narrow down the data to the variables you are interested in.

The `metrics` data set contains some stock fundamentals and does have more columns:

```{r}
(metrics <- rcourse::metrics)
```

We learn another {dplyr} verb: `select()`. Let's see it in action: `r emo::ji("clapper")`

```{r}
select(metrics, symbol, period, inventory)
select(metrics, 1:3)
select(metrics, -(symbol:ebit))
select(metrics, contains("eb"))
```

The `ni` column gives the company's net income. You don't like this label? Then `rename()` it:

```{r}
rename(metrics, net_income = ni)
```

The `cr` column is the company's cash ratio, which is defined as

$$\text{Cash ratio} = \frac{\text{Cash reserves}}{\text{Liabilities}}.$$
We can use this identity and the {dplyr} verb `mutate()` to create a new variable `cash` for the company's cash reserves:

```{r}
metrics_small <- select(metrics, symbol, period, cr, liabilities)
mutate(metrics_small, cash = cr * liabilities)
```

## Summarize data columns

The `prices` data set contains closing prices and trading volumes at the New York Stock Exchange from 2012 to 2016.

```{r}
(prices <- rcourse::prices)
```

The {dplyr} verb `summarize()` collapses a data frame to a single row:

```{r}
summarize(prices, mean_close = mean(close))
```

### Grouping

Summaries are more powerful when we pair them with `group_by()`: this allows to compute statistics for each group separately, e.g.:

```{r}
(by_stock <- group_by(prices, symbol))
summarize(by_stock, mean_close = mean(close))
```

### Combining multiple operations

We can make the last chunk more compact using the pipe operator `%>%` (contained in {dplyr} but exported from {magrittr}):

```{r}
prices %>%
  group_by(symbol) %>%
  summarize(mean_close = mean(close))
```

## What we learned

A lot of data manipulation in R!

### Verbs from {dplyr} to remember

- `filter()` to	filter rows

- `arrange()` to order rows

- `select()` to	select columns

- `mutate()` to	create columns

- `rename()` to rename columns

- `summarize()` to summarize columns

- `group_by()` for group operations

### All verbs work similar

- The first argument is a data frame.

- The subsequent arguments describe what you want to do with the data frame, using the variable names (without quotes).

- The result is a transformed data frame.

- You can chain multiple verbs using the pipe operator `%>%`.

### There is more

I recommend to take a look at the [package reference page](https://dplyr.tidyverse.org/reference/) to learn even more things you can do with {dplyr}.
