---
title: "Good practices in R"
output: 
  learnr::tutorial:
    allow_skip: true
    progressive: true
runtime: shiny_prerendered
description: >
  The practical part of the good practices in R course.
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("rcourse")
packages_required <- c("learnr")
install_if_missing(packages_required)
tutorial_options(
  exercise.completion = FALSE,
  exercise.diagnostics = FALSE
)
```

## Part 1: Code formatting

### Code style

You can modify and expand the code snippet below as needed. Run the code by clicking on `Run Code`. Find your exercises below. When you finished your exercises, click `Continue`.

If you prefer to work in RStudio, you can start a new session and copy the code there.

```{r code_style_1, exercise = TRUE}
a<-10
b<-5
c<-2
d<-a*b+c
if(d>0){
msg<-"Positive"
}else if(d<0){
msg<-"Negative"
}else{
msg<-"Zero"
}
print(msg)
```

1. Please run the code and understand what it does.
2. Then improve the code style by focusing on spacing, indentation, and commenting.

### Line length

```{r code_style_2, exercise = TRUE}
example_function <- function(x,y,z){result <- x * y + z; if(result > 0){return("Positive")}else if(result < 0){return("Negative")}else{return("Zero")}}
example_function(1,1,1)
```

1. What is similar in this code to the previous code? Where are differences?
2. Again find and fix issues related to inconsistent indentation and excessive line length.
3. Now find inputs such that the output of `example_function()` is `"Zero"`.

### The tidyverse style guide

The tidyverse is like a Swiss Army knife for R data scientists - a nifty collection of packages that turns messy data into a neat and tidy playground for exploration and visualization! It provides a style guide, which is a set of coding conventions and best practices for writing consistent, readable, and maintainable R code. It covers topics like syntax, naming conventions, indentation, and white space usage, promoting a unified coding style across projects.

1. Open <a href="https://style.tidyverse.org/index.html" target="_blank">the tidyverse style guide</a> and read the chapters "Files", "Syntax", and "Functions". The other chapters are also interesting, but more advanced.
2. Afterwards, please answer the following multiple choice questions.

```{r quiz_tidyverse}
quiz(
  question("What are (according to the tidyverse style guide) good variable names?",
    answer("`day_one`", correct = TRUE),
    answer("`day_1`", correct = TRUE),
    answer("`DayOne`"),
    answer("`dayone`"),
    answer("`first_day_of_the_month`"),
    answer("`djm1`"),
    answer("`mean`"),
    answer("`T`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How to assign values to variables?",
    answer("`x <- 5`", correct = TRUE),
    answer("`x = 5`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How to put spaces around commas?",
    answer("`x[, 1]`", correct = TRUE),
    answer("`x[,1]`"),
    answer("`x[ ,1]`"),
    answer("`x[ , 1]`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How to put spaces around parantheses?",
    answer("`mean(x, na.rm = TRUE)`", correct = TRUE),
    answer("`mean (x, na.rm = TRUE)`"),
    answer("`mean( x, na.rm = TRUE )`"),
    answer("`if (debug) { }`", correct = TRUE),
    answer("`function (x) {}`"),
    answer("`function(x) {}`", correct = TRUE),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How to put spaces around infix operators?",
    answer("`height <- (feet * 12) + inches`", correct = TRUE),
    answer("`mean(x, na.rm=TRUE)`"),
    answer("`x <- 1 : 10`"),
    answer("`? mean`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("What are good file names for R code?",
    answer("`fit_models.R`", correct = TRUE),
    answer("`utility_functions.R`", correct = TRUE),
    answer("`fit models.R`"),
    answer("`stuff.r`"),
    answer("`Datenanalyse.r`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("In code, use comments to explain the ...?",
    answer("\"why\".", correct = TRUE),
    answer("\"what\"."),
    answer("\"how\"."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("Where should you load add-on packages for your R script?",
    answer("Load them all at once at the very beginning of the file.", correct = TRUE),
    answer("Use `library()` calls at the first place in the code where the package is used."),
    answer("Use a startup file such as `.Rprofile`."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  )
)
```

## Part 2: Functions

### Getting started with function programming

If you are new to function programming in R, you can find detailed explanations <a href="https://r4ds.had.co.nz/functions.html" target="_blank">here</a>.

```{r quiz_functions}
quiz(
  question("How do you define a function in R?",
    answer("`function_name <- function() { ... }`", correct = TRUE),
    answer("`function function_name() { ... }`"),
    answer("`func function_name() { ... }`"),
    answer("`def function_name() { ... }`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do you return a `value` from a function in R?",
    answer("`return(value)`", correct = TRUE),
    answer("`output(value)`"),
    answer("`result(value)`"),
    answer("`answer(value)`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do you call a function with named arguments in R?",
    answer("`function_name(arg1 = value1, arg2 = value2)`", correct = TRUE),
    answer("`function_name{arg1 = value1, arg2 = value2}`"),
    answer("`function_name[arg1 = value1, arg2 = value2]`"),
    answer("`function_name<arg1 = value1, arg2 = value2>`"),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("Which of the following statements correctly describes default function arguments in R?",
    answer("Default function arguments are always required and must be specified when calling a function.", correct = TRUE),
    answer("Default function arguments allow a function to have optional arguments with predefined values."),
    answer("Default function arguments prevent a function from accepting any arguments."),
    answer("Default function arguments can only be used with user-defined functions, not with built-in functions."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  )
)
```

### Programming a function

Write your own function to compute the variance of a numeric vector. Remember that the variance is defined as $Var(x) = \frac{1}{n-1} \sum_{i=1}^n (x_i - \bar{x})^2$, where $\bar{x} = \frac{1}{n} \sum_{i=1}^n x_i$ denotes the arithmetic mean. Avoid to use the R functions `mean()`, `sd()`, or `var()`.

```{r function_variance, exercise = TRUE}


```

```{r function_variance-hint}
calculate_variance <- function(x) {
  mean <- ...
  variance <- ...
  return()
}
```

### Avoid code duplication

The following R code calculates the area of three rectangles. Improve the code to use a function that calculates the area of any rectangle given its length and width.

```{r function_area, exercise = TRUE}
# Rectangle 1
length1 <- 10
width1 <- 5
area1 <- length1 * width1

# Rectangle 2
length2 <- 8
width2 <- 4
area2 <- length2 * width2

# Rectangle 3
length3 <- 15
width3 <- 6
area3 <- length3 * width3
```

```{r function_area-hint}
calcualte_area <- function(length, width) {
  area <- ...
  return()
}
```

Next, you are given the following R code that transforms three strings by removing whitespace and converting them to lowercase. Improve the code to use a function that performs the string transformation for any given input string.

```{r function_whitespace, exercise = TRUE}
string1 <- " Hello World! "
string2 <- " My name is Lennart. "
string3 <- " Welcome to R programming. "

# Transform strings
clean_string1 <- tolower(trimws(string1))
clean_string2 <- tolower(trimws(string2))
clean_string3 <- tolower(trimws(string3))
```

## Part 3: Exceptions

### Warnings

Write a function `safe_division` that takes two arguments, `numerator` and `denominator`, and performs division. The function should handle the division-by-zero exception and return an appropriate *warning* when the denominator is zero.

```{r exception_1, exercise = TRUE}


```

```{r exception_1-hint}
safe_division <- function(numerator, denominator) {
  result <- ...
  if (denominator == 0) {
    warning()
  } 
  return()
}
```

Try adding `call. = TRUE` versus `call. = FALSE` to the `warning()` call. What is the difference? What do you prefer?

### Errors

Create a function `safe_sqrt` that takes a numeric value as input and computes its square root. The function should handle exceptions for negative input values, returning an *error* message when the input is negative.

```{r exception_2, exercise = TRUE}


```


### Safe temperature conversion

Create a function called `temp_conversion` that takes two arguments: a temperature value (`temp`) and a character indicating the conversion type (`type`). The function should convert temperatures between Celsius and Fahrenheit scales. If type is `"F_to_C"`, the function should convert the given temperature from Fahrenheit to Celsius. If type is `"C_to_F"`, the function should convert the temperature from Celsius to Fahrenheit. If the type is invalid, the function should return an appropriate error message. Test your function with different temperature values and conversion types.

Hint: The formulas for temperature conversion are as follows:

- Celsius to Fahrenheit: `temp * 9/5 + 32`
- Fahrenheit to Celsius: `(temp - 32) * 5/9`

```{r function_exception, exercise = TRUE}


```

You can find more about errors and warnings in R <a href="https://adv-r.hadley.nz/conditions.html" target="_blank">here</a>.

## Part 4: Debugging

### Application

```{r debug, exercise = TRUE}
factorial <- function(n){
  if (n > 1) result <- n * factorial(n - 1)
    return(result)
  } else {
    return(1)
}
factorial(5)
```

1. Investigate and debug the code such that it works properly.
2. Make the function more robust. Let the user know what went wrong in the following cases:
  - `factorial(5.23)`
  - `factorial("ABC")`
  - `factorial(-4)`
  
### Minimal reproducible example

What is a minimal reproducible example? Read about it <a href="https://stackoverflow.com/questions/5963269/how-to-make-a-great-r-reproducible-example" target="_blank">here</a>. 
  
## Part 5: Code efficiency

### Pre-allocation

```{r pre-allocation, exercise = TRUE}

```

1. Create a function that calculates the first `n` <a href="https://en.wikipedia.org/wiki/Fibonacci_sequence" target="_blank">Fibonacci numbers</a> using a `for` loop.
2. Test the function without pre-allocating memory for the result vector.
3. Modify the function to pre-allocate memory for the result vector.
4. Compare the time taken for each approach using the `system.time()` function.

### Vectorization

```{r vectorization, exercise = TRUE}

```

1. Generate a numeric vector of 10,000 random numbers between 1 and 100.
2. Calculate the square of each number in the vector using a `for` loop.
3. Now, use a vectorized approach (element-wise operations) to perform the same calculation.
4. Again, compare the time taken for each approach using the `system.time()` function.

