---
title: "Tutorial"
output: 
  learnr::tutorial:
    allow_skip: false
    progressive: true
runtime: shiny_prerendered
description: >
  The practical part of the data manipulation R course.
---

```{r setup, include = FALSE}
library("rcourse")
packages_required <- c("dplyr", "learnr", "tibble")
install_if_missing(packages_required)
knitr::opts_chunk$set(echo = FALSE)
Sys.setenv(LANG = "en")
```

## Part 1: Filter and arrange data rows

### Data overview

Type `stocks` and click `Run code` to print our stock data set.

```{r print_stocks, exercise = TRUE}

```

Type `?stocks` to learn more the variables.

```{r help, exercise = TRUE}

```

Apparently, `stocks` is a "tibble". But what is a tibble? Type `?tibble::tbl_df` to find out.

```{r tibble, exercise = TRUE}

```

### Find stocks

We want to use `filter()` to find all stocks that are in the finance sector. But for some reason, the following does not work. Do you know, why?

```{r sector, exercise = TRUE}
filter(stocks, sector = "Financials")
```

Now find all stocks that are *not* in the finance sector, were added to the S&P 500 *not later* than 1st May, 1991, and do have their headquarter in Texas. Their are five stocks that fulfill these conditions. If you find more or less, compare your code to the solution.

```{r notsector, exercise = TRUE}

```

```{r notsector-solution}
filter(stocks, sector != "Financials", added <= as.Date("1991-05-01"), hq == "Texas")
```

Now find all stocks that were added in 2005.

```{r added, exercise = TRUE}

```

```{r added-solution}
filter(stocks, added >= as.Date("2005-01-01"), added < as.Date("2006-01-01"))
```

Another useful filtering helper from {dplyr} is `between()`. Can you use it to simplify the code needed to answer the previous question?

```{r between, exercise = TRUE}

```

```{r between-solution}
?between
filter(stocks, between(added, as.Date("2005-01-01"), as.Date("2006-01-01")))
```

### Missing values

For 197 stocks, the date when they were added to the S&P 500 is missing in the data set. Print them!

```{r missing, exercise = TRUE}

```

In R, data points that are *not available* (i.e. missing) are stored as `NA`. Experiment a bit how R interprets `NA` in arithmetic and logical operations. Any surprises?

```{r nas, exercise = TRUE}
NA + 1
NA / 2
!NA
NA == 1
NA > 1
NA == NA
is.na(NA)
NA ^ 0
NA * 0
```

### Arranging rows

Change the order of the `stocks` data set to find the stocks that were added the earliest and the ones that were added the latest.

```{r arrange, excercise = TRUE}

```

```{r arrange-solution}
arrange(stocks, added)
arrange(stocks, desc(added))
```

Now use `arrange()` to sort all missing values of `added` to the top of the data set.

```{r natop, excercise = TRUE}

```

```{r natop-solution}
arrange(stocks, desc(is.na(added)))
```

### Logical operators

What is the difference between `&` and `&&`? Try to find out yourself with the following code:

```{r logicaland, exercise = TRUE}
x <- 1:3
x > 1 & x < 3
x > 1 && x < 3
```

### Quiz time!

```{r quiz1}
quiz(
  question("What does the package name 'dplyr' actually mean?",
    answer("'d' is for data frames, 'plyr' is to evoke pliers", correct = TRUE),
    answer("short for 'data manipulations in R'"),
    answer("'d' is for data, 'plyr' is for the layer"),
    answer("just random letters without any meaning")
  ),
  question("What do you think is the result of `NA | TRUE`?",
    answer("`NA`"),
    answer("`FALSE`"),
    answer("`TRUE`", correct = TRUE),
    answer("produces an error")
  ),
  question("How many rows does `filter(stocks, hq == \"Texas\", hq == \"New York\")` print?",
    answer("produces an error"),
    answer("all rows in `stocks`"),
    answer("no rows at all", correct = TRUE)
  )
)
```

## Part 2: Select and create data columns

### Select columns

We looked at a second data set. Get a data overview and look into the help page to learn more about the variables.

```{r print_metrics, exercise = TRUE}
metrics
```

Find as many ways as possible to select the columns `symbol`, `period`, and `rd` from `metrics`.

```{r select, exercise = TRUE}

```

Give the `rd` column a more descriptive name.

```{r rd, exercise = TRUE}

```

### Create columns

Use the columns `roe` and `ni` from `metrics` to create a column `equity` with the company's equity. You might first have to create a small version of the data set to see the created column in the output.

```{r equity, exercise = TRUE}

```

What is the difference if you'd use `transmute()` instead of `mutate()`?

```{r transmute, exercise = TRUE}

```

```{r transmute-solution}
metrics_small <- select(metrics, symbol, period, roe, ni)
mutate(metrics, equity = roe * ni)
transmute(metrics, equity = roe * ni)
```

### Quiz time!

```{r quiz2}
quiz(
  question("What happens if you include the same column name twice in `select()`?",
    answer("the column appears once", correct = TRUE),
    answer("the column appears twice"),
    answer("produces a warning")
  ),
  question("What happens if you include the same column name twice in `mutate()`?",
    answer("the first definition is used"),
    answer("the last definition is used", correct = TRUE),
    answer("produces a warning")
  ),
  question("What does the `symbol` column in `mutate(metrics, symbol = NULL)` will look like?",
    answer("a column where the first entry is `NULL` and the rest is `NA`"),
    answer("a column where each value is `NULL`"),
    answer("the output won't have a `symbol` column", correct = TRUE)
  )
)
```

## Part 3: Summarize data columns

### A third data set

We looked at a third data set. Get a data overview and look into the help page to learn more about the variables.

```{r print_prices, exercise = TRUE}
prices
```

### Compute grouped statstics

Compute the total trading volume for each day in the `prices` data set. Try to use the pipe operator `%>%` for more efficient coding.

```{r volume, exercise = TRUE}

```

```{r volume-solution}
prices %>% 
  group_by(date) %>% 
  summarize(total_trading_volume = sum(volume))
```

From the help page we know that `prices` contains closing prices and trading volumes at the New York Stock Exchange from 2012 to 2016. How many records per stock does the data set have? Use `table()` to get an overview.

```{r count, exercise = TRUE}

```

```{r count-solution}
### records per stock
counts <- prices %>% 
  group_by(symbol) %>% 
  summarize(count = n()) 

### overview
counts %>% 
  select(count) %>%
  table()
```

We see that for most of the stocks we have 1762 records, but for some we have less. E.g., for one stock we only have 126 data points. Which one is it? 

```{r lessrec, exercise = TRUE}

```

```{r lessrec-solution}
prices %>% 
  group_by(symbol) %>% 
  summarize(count = n()) %>% 
  filter(count == 126)
### The Fortive company (FTV) was founded in July 2016.
```

The following chunk computes the number of stocks that had days with zero trading volume. Try to understand what `count()` and `as.numeric()` do.

```{r zerotrading, exercise = TRUE}
prices %>% 
  filter(volume == 0) %>% 
  count() %>%
  as.numeric()
```

### Quiz time!

```{r quiz3}
quiz(
  question("What is the name of the {dplyr} verb to compute summary statistics?",
    answer("`summarize()`", correct = TRUE),
    answer("`summary()`"),
    answer("`summarise()`", correct = TRUE)
  ),
  question("What is the result of `1:4 %>% sum()`?",
    answer("`10`", correct = TRUE),
    answer("`5`"),
    answer("an error")
  ),
  question("How to use the pipe to rewrite `g(f(x, y), z)`?",
    answer("`g(z) %>% f(y) %>% x`"),
    answer("`f(x) %>% g(y) %>% z`"),
    answer("`x %>% f(y) %>% g(z)`", correct = TRUE)
  )
)
```